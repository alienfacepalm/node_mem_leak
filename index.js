"use strict";
require("heapdump");

var leakyData = [];
var nonLeakyData = [];

var fs = require("fs");
var stats = [];

class SimpleClass {
  constructor(text) {
    this.text = text;
  }
}

function cleanUpData(dataStore, randomObject) {
  var objectIndex = dataStore.indexOf(randomObject);
  dataStore.splice(objectIndex, 1);
}

function getAndStoreRandomData() {
  var randomData = Math.random().toString();
  var randomObject = new SimpleClass(randomData);

  leakyData.push(randomObject);
  nonLeakyData.push(randomObject);

  cleanUpData(leakyData, randomObject); //<-- Forgot to clean up
  cleanUpData(nonLeakyData, randomObject);
}

function generateHeapDumpAndStats() {
  //1. Force garbage collection every time this function is called
  try {
    global.gc();
  } catch (e) {
    console.log(
      "You must run program with 'node --expose-gc index.js' or 'npm start'"
    );
    process.exit();
  }

  //2. Output Heap stats
  var heapUsed = process.memoryUsage().heapUsed;
  stats.push(heapUsed);
  console.log("Program is using " + heapUsed + " bytes of Heap.");

  //3. Get Heap dump
  process.kill(process.pid, "SIGUSR2");
}

//Kick off the program
setInterval(getAndStoreRandomData, 5); //Add random data every 5 milliseconds
setInterval(generateHeapDumpAndStats, 2000); //Do garbage collection and heap dump every 2 seconds

//On ctrl+c save the stats and exit
process.on("SIGINT", function () {
  var data = JSON.stringify(stats);
  fs.writeFile("stats.json", data, function (err) {
    if (err) {
      console.log(err);
    } else {
      console.log("\nSaved stats to stats.json");
    }
    process.exit();
  });
});
